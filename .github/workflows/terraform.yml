name: Terraform Plan and Apply

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Prevent concurrent runs so state is never written by two jobs simultaneously
concurrency:
  group: terraform-deployment
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  TF_VERSION: 1.5.0
  TF_STATE_BUCKET: ppp-tf-state-simplon-pfe-v4

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # -------------------------------------------------------
      # PRE-APPLY CLEANUP
      # Frees VPC slots consumed by prior failed deployments.
      # NOTE: ppp-v4 IAM/CloudWatch are tracked in S3 state and
      # must NOT be deleted here — that causes EKS recreation.
      # -------------------------------------------------------
      - name: Pre-apply cleanup (free VPC slots from old deployments)
        run: |
          delete_vpc() {
            local VPC_ID=$1
            echo "  Tearing down VPC: $VPC_ID"
            for NGW in $(aws ec2 describe-nat-gateways --filter "Name=vpc-id,Values=$VPC_ID" "Name=state,Values=available,pending" --query 'NatGateways[*].NatGatewayId' --output text 2>/dev/null); do
              [ "$NGW" != "None" ] && aws ec2 delete-nat-gateway --nat-gateway-id $NGW 2>/dev/null && echo "    Deleting NAT GW: $NGW" || true
            done
            echo "    Waiting 50s for NAT Gateways to finish deleting..."
            sleep 50
            for EIP in $(aws ec2 describe-addresses --query 'Addresses[?AssociationId==null].AllocationId' --output text 2>/dev/null); do
              [ -n "$EIP" ] && [ "$EIP" != "None" ] && aws ec2 release-address --allocation-id $EIP 2>/dev/null || true
            done
            for IGW in $(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$VPC_ID" --query 'InternetGateways[*].InternetGatewayId' --output text 2>/dev/null); do
              [ -n "$IGW" ] && [ "$IGW" != "None" ] && aws ec2 detach-internet-gateway --internet-gateway-id $IGW --vpc-id $VPC_ID 2>/dev/null || true
              [ -n "$IGW" ] && [ "$IGW" != "None" ] && aws ec2 delete-internet-gateway --internet-gateway-id $IGW 2>/dev/null || true
            done
            for SUBNET in $(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query 'Subnets[*].SubnetId' --output text 2>/dev/null); do
              [ -n "$SUBNET" ] && [ "$SUBNET" != "None" ] && aws ec2 delete-subnet --subnet-id $SUBNET 2>/dev/null || true
            done
            for RT in $(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$VPC_ID" --query 'RouteTables[?length(Associations[?Main==`true`])==`0`].RouteTableId' --output text 2>/dev/null); do
              [ -n "$RT" ] && [ "$RT" != "None" ] && aws ec2 delete-route-table --route-table-id $RT 2>/dev/null || true
            done
            for SG in $(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$VPC_ID" --query 'SecurityGroups[?GroupName!=`default`].GroupId' --output text 2>/dev/null); do
              [ -n "$SG" ] && [ "$SG" != "None" ] && aws ec2 delete-security-group --group-id $SG 2>/dev/null || true
            done
            aws ec2 delete-vpc --vpc-id $VPC_ID 2>/dev/null && echo "  Deleted VPC $VPC_ID" || echo "  Could not delete $VPC_ID (skipping)"
          }

          for PREFIX in devops-ppp ppp-v2 ppp-v3; do
            VPC_ID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=${PREFIX}-production-vpc" --query 'Vpcs[0].VpcId' --output text 2>/dev/null)
            if [ -n "$VPC_ID" ] && [ "$VPC_ID" != "None" ]; then
              echo "Found orphaned VPC for $PREFIX: $VPC_ID — deleting"
              delete_vpc $VPC_ID
            else
              echo "No orphaned VPC for $PREFIX"
            fi
          done
          echo "=== Pre-apply cleanup complete ==="

      - name: Create S3 state bucket
        run: |
          aws s3api create-bucket \
            --bucket ${{ env.TF_STATE_BUCKET }} \
            --region ${{ env.AWS_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }} 2>/dev/null \
            && echo "Bucket created" || echo "Bucket already exists (ok)"
          aws s3api put-bucket-versioning \
            --bucket ${{ env.TF_STATE_BUCKET }} \
            --versioning-configuration Status=Enabled 2>/dev/null || true

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=ppp-v4/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Apply
        run: terraform apply -auto-approve
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
