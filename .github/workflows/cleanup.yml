name: Cleanup Orphaned AWS Resources
on: workflow_dispatch
jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Cleanup All Regions
        run: |
          for REGION in "us-east-1" "us-east-2"; do
            echo "--- Cleaning up region $REGION ---"
            export AWS_DEFAULT_REGION=$REGION
            
            # Global Roles (Region independent but we can run them here, ignores if deleted)
            for PREFIX in "devops-ppp" "ppp-v2"; do
              for ROLE in "${PREFIX}-production-eks-cluster-role" "${PREFIX}-production-eks-node-group-role" "${PREFIX}-production-sqs-consumer-role"; do
                aws iam detach-role-policy --role-name $ROLE --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterPolicy >/dev/null 2>&1 || true
                aws iam detach-role-policy --role-name $ROLE --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy >/dev/null 2>&1 || true
                aws iam detach-role-policy --role-name $ROLE --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy >/dev/null 2>&1 || true
                aws iam detach-role-policy --role-name $ROLE --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly >/dev/null 2>&1 || true
                
                POLICY=$(aws iam list-policies --query "Policies[?PolicyName==\`${PREFIX}-production-sqs-access-policy\`].Arn" --output text 2>/dev/null || echo "")
                if [ -n "$POLICY" ] && [ "$POLICY" != "None" ]; then
                  aws iam detach-role-policy --role-name $ROLE --policy-arn $POLICY >/dev/null 2>&1 || true
                fi
                aws iam delete-role --role-name $ROLE >/dev/null 2>&1 || true
              done
              
              POLICY=$(aws iam list-policies --query "Policies[?PolicyName==\`${PREFIX}-production-sqs-access-policy\`].Arn" --output text 2>/dev/null || echo "")
              if [ -n "$POLICY" ] && [ "$POLICY" != "None" ]; then
                aws iam delete-policy --policy-arn $POLICY >/dev/null 2>&1 || true
              fi
            done
            
            # Release orphaned EIPs in this region
            for eip in $(aws ec2 describe-addresses --query 'Addresses[?AssociationId==null].AllocationId' --output text 2>/dev/null || echo ""); do
              if [ -n "$eip" ] && [ "$eip" != "None" ]; then
                echo "Releasing orphaned EIP: $eip"
                aws ec2 release-address --allocation-id $eip >/dev/null 2>&1 || true
              fi
            done
            
            # Delete Log Groups and SQS
            for PREFIX in "devops-ppp" "ppp-v2"; do
              aws logs delete-log-group --log-group-name /aws/${PREFIX}/production/application >/dev/null 2>&1 || true
              aws logs delete-log-group --log-group-name /aws/${PREFIX}/production/backend >/dev/null 2>&1 || true
              aws logs delete-log-group --log-group-name /aws/${PREFIX}/production/frontend >/dev/null 2>&1 || true
              aws logs delete-log-group --log-group-name /aws/eks/${PREFIX}-production-cluster/cluster >/dev/null 2>&1 || true
              
              aws sqs delete-queue --queue-url https://sqs.${REGION}.amazonaws.com/${{ secrets.AWS_ACCOUNT_ID }}/${PREFIX}-production-dlq >/dev/null 2>&1 || true
              aws sqs delete-queue --queue-url https://sqs.${REGION}.amazonaws.com/${{ secrets.AWS_ACCOUNT_ID }}/${PREFIX}-production-queue >/dev/null 2>&1 || true
            done
          done
          echo "DONE. Remember to manually delete the 'devops-ppp-production-vpc' (us-east-1) and 'ppp-v2-production-vpc' (us-east-2) in the AWS Console."
