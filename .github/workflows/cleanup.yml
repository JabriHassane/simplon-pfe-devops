name: Cleanup Orphaned AWS Resources
on: workflow_dispatch
jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Cleanup Orphaned Roles and EIPs
        run: |
          echo "Deleting IAM Roles..."
          aws iam detach-role-policy --role-name devops-ppp-production-eks-cluster-role --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterPolicy || true
          aws iam delete-role --role-name devops-ppp-production-eks-cluster-role || true
          
          aws iam detach-role-policy --role-name devops-ppp-production-eks-node-group-role --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy || true
          aws iam detach-role-policy --role-name devops-ppp-production-eks-node-group-role --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy || true
          aws iam detach-role-policy --role-name devops-ppp-production-eks-node-group-role --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly || true
          aws iam delete-role --role-name devops-ppp-production-eks-node-group-role || true
          
          POLICY=$(aws iam list-policies --query 'Policies[?PolicyName==`devops-ppp-production-sqs-access-policy`].Arn' --output text)
          if [ -n "$POLICY" ]; then
            aws iam detach-role-policy --role-name devops-ppp-production-sqs-consumer-role --policy-arn $POLICY || true
            aws iam delete-policy --policy-arn $POLICY || true
          fi
          aws iam delete-role --role-name devops-ppp-production-sqs-consumer-role || true
          
          echo "Releasing orphaned Elastic IPs..."
          for eip in $(aws ec2 describe-addresses --query 'Addresses[?AssociationId==null].AllocationId' --output text); do
            echo "Releasing EIP: $eip"
            aws ec2 release-address --allocation-id $eip || true
          done
          
          echo "Deleting Log Groups..."
          aws logs delete-log-group --log-group-name /aws/devops-ppp/production/application || true
          aws logs delete-log-group --log-group-name /aws/devops-ppp/production/backend || true
          aws logs delete-log-group --log-group-name /aws/devops-ppp/production/frontend || true
          aws logs delete-log-group --log-group-name /aws/eks/devops-ppp-production-cluster/cluster || true
          
          echo "DONE. Note: Please manually delete the VPC named 'devops-ppp-production-vpc' in the AWS Console (us-east-1)."
