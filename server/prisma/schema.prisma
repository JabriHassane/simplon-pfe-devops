// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  super_admin
  admin
  agent
}

model User {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name     String  @unique
  password String?
  role     Role

  // Relations
  agentSales        Sale[]        @relation("SaleAgent")
  agentPurchases    Purchase[]    @relation("PurchaseAgent")
  agentTransactions Transaction[] @relation("TransactionAgent")

  createdSales Sale[] @relation("SaleCreatedBy")
  updatedSales Sale[] @relation("SaleUpdatedBy")
  deletedSales Sale[] @relation("SaleDeletedBy")

  createdPurchases Purchase[] @relation("PurchaseCreatedBy")
  updatedPurchases Purchase[] @relation("PurchaseUpdatedBy")
  deletedPurchases Purchase[] @relation("PurchaseDeletedBy")

  createdTransactions Transaction[] @relation("TransactionCreatedBy")
  updatedTransactions Transaction[] @relation("TransactionUpdatedBy")
  deletedTransactions Transaction[] @relation("TransactionDeletedBy")

  createdClients Client[] @relation("ClientCreatedBy")
  updatedClients Client[] @relation("ClientUpdatedBy")
  deletedClients Client[] @relation("ClientDeletedBy")

  createdSuppliers Supplier[] @relation("SupplierCreatedBy")
  updatedSuppliers Supplier[] @relation("SupplierUpdatedBy")
  deletedSuppliers Supplier[] @relation("SupplierDeletedBy")

  createdUsers User[] @relation("UserCreatedBy")
  updatedUsers User[] @relation("UserUpdatedBy")
  deletedUsers User[] @relation("UserDeletedBy")

  refreshTokens RefreshToken[]

  createdById String?
  createdBy   User?   @relation("UserCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("UserUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("UserDeletedBy", fields: [deletedById], references: [id])

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@map("refresh_tokens")
}

model Client {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name    String
  phone   String
  address String? @default("")

  // Relations
  sales Sale[]

  createdById String?
  createdBy   User?   @relation("ClientCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("ClientUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("ClientDeletedBy", fields: [deletedById], references: [id])

  @@map("clients")
}

model Supplier {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name    String
  phone   String
  address String? @default("")

  // Relations
  purchases Purchase[]

  createdById String?
  createdBy   User?   @relation("SupplierCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("SupplierUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("SupplierDeletedBy", fields: [deletedById], references: [id])

  @@map("suppliers")
}

enum OrderStatus {
  pending
  partially_paid
  paid
  cancelled
}

model Sale {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date DateTime

  receiptNumber String?
  invoiceNumber String?

  totalPrice Float
  totalPaid  Float
  totalDue   Float

  status OrderStatus
  note   String?

  // Relations
  agentId String?
  agent   User?   @relation("SaleAgent", fields: [agentId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  payments Transaction[]

  createdById String?
  createdBy   User?   @relation("SaleCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("SaleUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("SaleDeletedBy", fields: [deletedById], references: [id])

  @@map("sales")
}

model Purchase {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date DateTime

  receiptNumber String?
  invoiceNumber String?

  totalPrice Float
  totalPaid  Float
  totalDue   Float

  status OrderStatus
  note   String?

  // Relations
  agentId String?
  agent   User?   @relation("PurchaseAgent", fields: [agentId], references: [id])

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  payments Transaction[]

  createdById String?
  createdBy   User?   @relation("PurchaseCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("PurchaseUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("PurchaseDeletedBy", fields: [deletedById], references: [id])

  @@map("purchases")
}

enum TransactionMethod {
  cash
  check
  tpe
  bank_transfer
}

enum TransactionType {
  purchase
  sale
  send
  receive
  cashing
}

model Transaction {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date          DateTime
  type          TransactionType
  method        TransactionMethod
  transferActor String?
  amount        Float
  isCashed     Boolean           @default(false)

  // Relations
  agentId String?
  agent   User?   @relation("TransactionAgent", fields: [agentId], references: [id])

  saleId String?
  sale   Sale?   @relation(fields: [saleId], references: [id])

  purchaseId String?
  purchase   Purchase? @relation(fields: [purchaseId], references: [id])

  createdById String?
  createdBy   User?   @relation("TransactionCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("TransactionUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("TransactionDeletedBy", fields: [deletedById], references: [id])

  @@map("transactions")
}
