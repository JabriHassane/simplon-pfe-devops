generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  super_admin
  admin
  agent
}

model User {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name     String  @unique
  password String?
  role     Role

  // Relations
  agentOrders       Order[]       @relation("OrderAgent")
  agentTransactions Transaction[] @relation("TransactionAgent")

  createdOrders Order[] @relation("OrderCreatedBy")
  updatedOrders Order[] @relation("OrderUpdatedBy")
  deletedOrders Order[] @relation("OrderDeletedBy")

  createdTransactions Transaction[] @relation("TransactionCreatedBy")
  updatedTransactions Transaction[] @relation("TransactionUpdatedBy")
  deletedTransactions Transaction[] @relation("TransactionDeletedBy")

  createdContacts Contact[] @relation("ContactCreatedBy")
  updatedContacts Contact[] @relation("ContactUpdatedBy")
  deletedContacts Contact[] @relation("ContactDeletedBy")

  createdUsers User[] @relation("UserCreatedBy")
  updatedUsers User[] @relation("UserUpdatedBy")
  deletedUsers User[] @relation("UserDeletedBy")

  refreshTokens RefreshToken[]

  createdById String?
  createdBy   User?   @relation("UserCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("UserUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("UserDeletedBy", fields: [deletedById], references: [id])

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@map("refresh_tokens")
}

enum ContactType {
  client
  supplier
}

model Contact {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name    String
  phone   String?
  address String?     @default("")
  type    ContactType

  // Relations
  orders Order[]

  createdById String?
  createdBy   User?   @relation("ContactCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("ContactUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("ContactDeletedBy", fields: [deletedById], references: [id])

  @@map("contacts")
}

enum OrderStatus {
  partially_paid
  paid
}

enum OrderType {
  sale
  purchase
}

model Order {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date DateTime

  receiptNumber String?
  invoiceNumber String?

  totalPrice Float @default(0)
  totalPaid  Float @default(0)
  totalDue   Float @default(0)

  type OrderType

  // Relations
  agentId String
  agent   User   @relation("OrderAgent", fields: [agentId], references: [id])

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  payments Transaction[]

  createdById String?
  createdBy   User?   @relation("OrderCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("OrderUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("OrderDeletedBy", fields: [deletedById], references: [id])

  @@map("orders")
}

enum TransactionMethod {
  cash
  check
  tpe
  bank_transfer
}

enum TransactionType {
  purchase
  sale
  send
  receive
  cashing
  deposit
}

model Transaction {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date          DateTime
  type          TransactionType
  method        TransactionMethod
  transferActor String?
  amount        Float?

  cashingTransactionId String?      @unique
  cashingTransaction   Transaction? @relation("TransactionCashing", fields: [cashingTransactionId], references: [id])
  cashedPayment        Transaction? @relation("TransactionCashing")

  depositTransactionId String?      @unique
  depositTransaction   Transaction? @relation("TransactionDeposit", fields: [depositTransactionId], references: [id])
  depositedPayment     Transaction? @relation("TransactionDeposit")

  // Relations
  agentId String
  agent   User   @relation("TransactionAgent", fields: [agentId], references: [id])

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  createdById String?
  createdBy   User?   @relation("TransactionCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("TransactionUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("TransactionDeletedBy", fields: [deletedById], references: [id])

  @@map("transactions")
}
