// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  super_admin
  admin
  agent
}

enum SaleStatus {
  pending
  partially_paid
  paid
  cancelled
}

enum PaymentMethod {
  cash
  check
  tpe
  bankTransfer
}

enum TransactionType {
  purchase
  sale
  transfer
}

model User {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name     String  @unique
  password String?
  role     Role

  // Relations
  agentSales        Sale[]        @relation("SaleAgent")
  agentPurchases    Purchase[]    @relation("PurchaseAgent")
  agentTransactions Transaction[] @relation("TransactionAgent")

  createdSales Sale[] @relation("SaleCreatedBy")
  updatedSales Sale[] @relation("SaleUpdatedBy")
  deletedSales Sale[] @relation("SaleDeletedBy")

  createdPurchases Purchase[] @relation("PurchaseCreatedBy")
  updatedPurchases Purchase[] @relation("PurchaseUpdatedBy")
  deletedPurchases Purchase[] @relation("PurchaseDeletedBy")

  createdAccounts Account[] @relation("AccountCreatedBy")
  updatedAccounts Account[] @relation("AccountUpdatedBy")
  deletedAccounts Account[] @relation("AccountDeletedBy")

  createdTransactions Transaction[] @relation("TransactionCreatedBy")
  updatedTransactions Transaction[] @relation("TransactionUpdatedBy")
  deletedTransactions Transaction[] @relation("TransactionDeletedBy")

  createdClients Client[] @relation("ClientCreatedBy")
  updatedClients Client[] @relation("ClientUpdatedBy")
  deletedClients Client[] @relation("ClientDeletedBy")

  createdSuppliers Supplier[] @relation("SupplierCreatedBy")
  updatedSuppliers Supplier[] @relation("SupplierUpdatedBy")
  deletedSuppliers Supplier[] @relation("SupplierDeletedBy")

  createdCategories Category[] @relation("CategoryCreatedBy")
  updatedCategories Category[] @relation("CategoryUpdatedBy")
  deletedCategories Category[] @relation("CategoryDeletedBy")

  createdArticles Article[] @relation("ArticleCreatedBy")
  updatedArticles Article[] @relation("ArticleUpdatedBy")
  deletedArticles Article[] @relation("ArticleDeletedBy")

  createdSaleItems SaleItem[] @relation("SaleItemCreatedBy")
  updatedSaleItems SaleItem[] @relation("SaleItemUpdatedBy")
  deletedSaleItems SaleItem[] @relation("SaleItemDeletedBy")

  createdPurchaseItems PurchaseItem[] @relation("PurchaseItemCreatedBy")
  updatedPurchaseItems PurchaseItem[] @relation("PurchaseItemUpdatedBy")
  deletedPurchaseItems PurchaseItem[] @relation("PurchaseItemDeletedBy")

  createdUsers User[] @relation("UserCreatedBy")
  updatedUsers User[] @relation("UserUpdatedBy")
  deletedUsers User[] @relation("UserDeletedBy")

  refreshTokens RefreshToken[]

  createdById String?
  createdBy   User?   @relation("UserCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("UserUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("UserDeletedBy", fields: [deletedById], references: [id])

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@map("refresh_tokens")
}

model Client {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name    String
  phone   String
  address String? @default("")

  // Relations
  sales Sale[]

  createdById String?
  createdBy   User?   @relation("ClientCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("ClientUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("ClientDeletedBy", fields: [deletedById], references: [id])

  @@map("clients")
}

model Supplier {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name    String
  phone   String
  address String? @default("")

  // Relations
  purchases Purchase[]

  createdById String?
  createdBy   User?   @relation("SupplierCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("SupplierUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("SupplierDeletedBy", fields: [deletedById], references: [id])

  @@map("suppliers")
}

model Category {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name String

  // Relations
  articles Article[]

  createdById String?
  createdBy   User?   @relation("CategoryCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("CategoryUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("CategoryDeletedBy", fields: [deletedById], references: [id])

  @@map("categories")
}

model Article {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name      String
  image     String
  price     Float

  // Relations
  categoryId    String?
  category      Category?      @relation(fields: [categoryId], references: [id])
  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]

  createdById String?
  createdBy   User?   @relation("ArticleCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("ArticleUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("ArticleDeletedBy", fields: [deletedById], references: [id])

  @@map("articles")
}

model Sale {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date DateTime

  receiptNumber String?
  invoiceNumber String?

  totalPrice Float
  totalPaid  Float
  totalDue   Float

  status SaleStatus
  note   String?

  // Relations
  agentId String?
  agent   User?   @relation("SaleAgent", fields: [agentId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  items    SaleItem[]
  payments Transaction[]

  createdById String?
  createdBy   User?   @relation("SaleCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("SaleUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("SaleDeletedBy", fields: [deletedById], references: [id])

  @@map("sales")
}

model SaleItem {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  price    Float
  quantity Int

  // Relations
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  articleId String?
  article   Article? @relation(fields: [articleId], references: [id])

  articleName String?

  createdById String?
  createdBy   User?   @relation("SaleItemCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("SaleItemUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("SaleItemDeletedBy", fields: [deletedById], references: [id])

  @@map("sale_items")
}

model Purchase {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date DateTime

  receiptNumber String?
  invoiceNumber String?

  totalPrice Float
  totalPaid  Float
  totalDue   Float

  status SaleStatus
  note   String?

  // Relations
  agentId String?
  agent   User?   @relation("PurchaseAgent", fields: [agentId], references: [id])

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  items    PurchaseItem[]
  payments Transaction[]

  createdById String?
  createdBy   User?   @relation("PurchaseCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("PurchaseUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("PurchaseDeletedBy", fields: [deletedById], references: [id])

  @@map("purchases")
}

model PurchaseItem {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  price    Float
  quantity Int

  // Relations
  purchaseId String
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  articleId String?
  article   Article? @relation(fields: [articleId], references: [id])

  articleName String?

  createdById String?
  createdBy   User?   @relation("PurchaseItemCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("PurchaseItemUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("PurchaseItemDeletedBy", fields: [deletedById], references: [id])

  @@map("purchase_items")
}

model Account {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  name    String
  balance Float
  paymentMethods String[]

  // Relations
  transactionsFrom Transaction[] @relation("AccountFrom")
  transactionsTo   Transaction[] @relation("AccountTo")

  createdById String?
  createdBy   User?   @relation("AccountCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("AccountUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("AccountDeletedBy", fields: [deletedById], references: [id])

  @@map("accounts")
}

model Transaction {
  id        String    @id @default(cuid())
  ref       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime?
  deletedAt DateTime?

  date          DateTime
  type          TransactionType
  paymentMethod PaymentMethod
  amount        Float

  // Relations
  agentId String?
  agent   User?   @relation("TransactionAgent", fields: [agentId], references: [id])

  saleId String?
  sale   Sale?   @relation(fields: [saleId], references: [id])

  purchaseId String?
  purchase   Purchase? @relation(fields: [purchaseId], references: [id])

  fromId String?
  from   Account? @relation("AccountFrom", fields: [fromId], references: [id])

  toId String?
  to   Account? @relation("AccountTo", fields: [toId], references: [id])

  createdById String?
  createdBy   User?   @relation("TransactionCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("TransactionUpdatedBy", fields: [updatedById], references: [id])
  deletedById String?
  deletedBy   User?   @relation("TransactionDeletedBy", fields: [deletedById], references: [id])

  @@map("transactions")
}
